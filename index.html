<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>IQ Arena â€“ Hexa Flow</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --neon:#00ffe1;
  --bg:#05050a;
  --glass:rgba(255,255,255,.08);
}

*{
  box-sizing:border-box;
  font-family:Segoe UI, sans-serif;
}

body{
  margin:0;
  background:radial-gradient(circle at top,#0a0a18,var(--bg));
  color:white;
  height:100vh;
  overflow:hidden;
}

/* ========== MAP ========== */
#map{
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  gap:30px;
}

.node{
  width:70px;
  height:70px;
  border-radius:50%;
  background:var(--glass);
  backdrop-filter:blur(12px);
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  font-size:20px;
  box-shadow:0 0 15px rgba(0,255,225,.4);
  transition:.3s;
}

.node.locked{
  opacity:.25;
  pointer-events:none;
}

.node:hover{
  box-shadow:0 0 30px var(--neon);
}

/* ========== GAME ========== */
#game{
  display:none;
  height:100vh;
  padding-top:40px;
}

#grid{
  display:grid;
  grid-template-columns:repeat(3,90px);
  gap:10px;
  justify-content:center;
}

.hex{
  width:90px;
  height:104px;
  clip-path:polygon(
    50% 0%,93% 25%,93% 75%,
    50% 100%,7% 75%,7% 25%
  );
  background:#111;
  position:relative;
  cursor:pointer;
}

.pipe{
  position:absolute;
  inset:18px;
  border:3px solid var(--neon);
  border-radius:12px;
  filter:drop-shadow(0 0 8px var(--neon));
  transition:.3s;
}

.source{
  background:#003a3a;
}

.target{
  background:#3a0000;
}

.win .pipe{
  filter:drop-shadow(0 0 20px var(--neon));
}
</style>
</head>

<body>

<!-- MAP SCREEN -->
<div id="map"></div>

<!-- GAME SCREEN -->
<div id="game">
  <div id="grid"></div>
</div>

<script>
/* ===== LEVEL DATA ===== */
const levels = [
 [
  {type:"source", con:[3]},
  {type:"normal", con:[0,3]},
  {type:"normal", con:[0]},
  {type:"normal", con:[3]},
  {type:"normal", con:[0,3]},
  {type:"target", con:[0]}
 ],
 [
  {type:"source", con:[2]},
  {type:"normal", con:[5,2]},
  {type:"normal", con:[5]},
  {type:"normal", con:[2]},
  {type:"normal", con:[5,2]},
  {type:"target", con:[5]}
 ]
];

/* ===== STATE ===== */
let unlocked = Number(localStorage.getItem("iq_unlocked")) || 0;
const map = document.getElementById("map");
const grid = document.getElementById("grid");
let current = [];

/* ===== BUILD MAP ===== */
function buildMap(){
  map.innerHTML="";
  levels.forEach((_,i)=>{
    const node=document.createElement("div");
    node.className="node"+(i>unlocked?" locked":"");
    node.textContent=i+1;
    node.onclick=()=>startLevel(i);
    map.appendChild(node);
  });
}
buildMap();

/* ===== START LEVEL ===== */
function startLevel(index){
  map.style.display="none";
  document.getElementById("game").style.display="block";
  buildGrid(index);
}

/* ===== BUILD GRID ===== */
function buildGrid(level){
  grid.innerHTML="";
  current = levels[level].map(c=>({
    ...c,
    rot:Math.floor(Math.random()*6)
  }));

  current.forEach((cell,i)=>{
    const hex=document.createElement("div");
    hex.className="hex "+cell.type;

    const pipe=document.createElement("div");
    pipe.className="pipe";
    pipe.style.transform=`rotate(${cell.rot*60}deg)`;
    hex.appendChild(pipe);

    hex.onclick=()=>{
      cell.rot=(cell.rot+1)%6;
      pipe.style.transform=`rotate(${cell.rot*60}deg)`;
      checkWin(level);
    };

    grid.appendChild(hex);
  });
}

/* ===== CHECK CONNECTION ===== */
function checkWin(level){
  if(tracePath()){
    document.body.classList.add("win");
    setTimeout(()=>{
      document.body.classList.remove("win");
      unlocked=Math.max(unlocked,level+1);
      localStorage.setItem("iq_unlocked",unlocked);
      location.reload();
    },900);
  }
}

/* ===== PATH TRACE ===== */
function tracePath(){
  const start=current.findIndex(c=>c.type==="source");
  const visited=new Set();
  return dfs(start);

  function dfs(i){
    if(i<0||i>=current.length||visited.has(i))return false;
    visited.add(i);
    if(current[i].type==="target")return true;

    for(let d of current[i].con){
      const real=(d+current[i].rot)%6;
      const next=i+dir(real);
      if(dfs(next))return true;
    }
    return false;
  }
}

/* ===== HEX DIRECTION ===== */
function dir(d){
  return [-3,-2,1,3,2,-1][d];
}
</script>

</body>
</html>
